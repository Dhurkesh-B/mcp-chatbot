<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhurkesh's Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
    <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>Hello BuddyðŸ‘‹</h1>
            <p>I'm Dhurkesh's personal assistant. How can I help you today?</p>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be added here dynamically -->
        </div>

        <div class="chat-input-container">
            <input type="text" id="message-input" placeholder="Type your message here..." autocomplete="off">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        let ws = null;
        let typingIndicator = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = function() {
                console.log('WebSocket connection established');
            };

            ws.onmessage = function(event) {
                removeTypingIndicator();
                addMessage(event.data, 'assistant');
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            ws.onclose = function() {
                console.log('WebSocket connection closed. Reconnecting...');
                setTimeout(connectWebSocket, 1000);
            };
        }

        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message markdown-body`;
            messageDiv.innerHTML = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            removeTypingIndicator(); // Ensure only one indicator
            typingIndicator = document.createElement('div');
            typingIndicator.id = 'lottie-typing-indicator';
            typingIndicator.innerHTML = `
                <dotlottie-player src="https://lottie.host/1deeb259-89f2-48e0-9ac4-11f8393c61c7/20dqyCTmG6.lottie" background="transparent" speed="1" style="width: 85px; height: 85px" loop autoplay muted></dotlottie-player>
            `;
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('lottie-typing-indicator');
            if (indicator) {
                indicator.remove();
            }
            typingIndicator = null;
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                addMessage(message, 'user');
                ws.send(message);
                messageInput.value = '';
                showTypingIndicator();
            } else {
                console.error('WebSocket is not connected');
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Connect to WebSocket when page loads
        connectWebSocket();
    </script>
</body>
</html> 